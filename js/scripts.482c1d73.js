"use strict";moment.locale("fr",{months:"Janvier_Février_Mars_Avril_Mai_Juin_Juillet_Août_Septembre_Octobre_Novembre_Décembre".split("_"),monthsShort:"Janv._Févr._Mars_Avr._Mai_Juin_Juil._Août_Sept._Oct._Nov._Déc.".split("_"),weekdays:"Dimanche_Lundi_Mardi_Mercredi_Jeudi_Vendredi_Samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd D MMMM YYYY LT"},calendar:{sameDay:"[Aujourd'hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"une année",yy:"%d années"},ordinal:function(a){return a+(1===a?"er":"ème")},week:{dow:1,doy:4}}),angular.module("tempoAdminApp",["ngRoute","ngSanitize","ngTouch","divonaEjp","divonaForecast","divonaTempo"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"partials/home.html",controller:"HomeCtrl"}).when("/tempo",{templateUrl:"partials/tempo.html",controller:"TempoCtrl"}).when("/ejp",{templateUrl:"partials/ejp.html",controller:"EjpCtrl"}).otherwise({redirectTo:"/home"})}]),angular.module("tempoAdminApp").controller("MainCtrl",["$scope","Utils",function(a,b){a.utils=b}]),angular.module("tempoAdminApp").controller("HomeCtrl",["$scope",function(){}]),angular.module("tempoAdminApp").controller("EjpCtrl",["$scope","$timeout","Utils","EJP",function(a,b,c,d){a.utils=c,a.date=d.getStartDate(),a.$watch("date",function(){a.loadData()}),a.loadData=function(){d.getYearByDate(a.date,!0).then(function(b){d.getYearByDate(a.date.clone().add(1,"year"),!0).then(function(c){a.data=angular.extend(b,c)})})},a.changeYear=function(b){a.date=b};var e={};a.onCalendarDayZoneClick=function(c,f){b.cancel(e[c.date.unix()]);var g=void 0;!1===c.data[f]&&(g=!0),!0===c.data[f]&&(g=void 0),void 0===c.data[f]&&(g=!1);var h=a.utils.apikey;if(!h)return void alert("Please enter APIKEY");c.data[f]=g;var i={};for(var j in c.data)i[j]=c.data[j];var k="boolean"==typeof i.north&&"boolean"==typeof i.paca&&"boolean"==typeof i.west&&"boolean"==typeof i.south,l=void 0===i.north&&void 0===i.paca&&void 0===i.west&&void 0===i.south;e[c.date.unix()]=b(function(){k&&d.save(h,c.date,i).then(function(){c.data=i},function(){c.data={north:void 0,paca:void 0,west:void 0,south:void 0}}),l&&d.delete(h,c.date).then(function(){c.data={north:void 0,paca:void 0,west:void 0,south:void 0}})},1500)},a.onCalendarDayDblClick=function(b){var c=a.utils.apikey;if(!c)return void alert("Please enter APIKEY");var e={north:!1,paca:!1,west:!1,south:!1};d.save(c,b.date,e).then(function(){b.data=e},function(){b.data={north:void 0,paca:void 0,west:void 0,south:void 0}})}}]),angular.module("tempoAdminApp").controller("TempoCtrl",["$scope","$timeout","Utils","Tempo",function(a,b,c,d){a.utils=c,a.date=d.getStartDate(),a.$watch("date",function(){a.loadData()}),a.loadData=function(){d.getYear(a.date,!0).then(function(b){d.getYear(a.date.clone().add(1,"year"),!0).then(function(c){a.data=angular.extend(b,c)})})},a.changeYear=function(b){a.date=b};var e={};a.onCalendarDayClick=function(c){b.cancel(e[c.date.unix()]);var f=c.data.raw;switch(c.data.raw){case"blue":f="white";break;case"white":f="red";break;case"red":f="undefined";break;default:f="blue"}var g=a.utils.apikey;return g?(c.data.raw=f,void(e[c.date.unix()]=b(function(){"undefined"!==f?d.save(g,c.date,f).then(function(){c.data.raw=f,c.data.formated=d.formatColor(c.data.raw)}):d.delete(g,c.date).then(function(){c.data.raw="undefined",c.data.formated="-"})},1500))):void alert("Please enter APIKEY")}}]),angular.module("tempoAdminApp").directive("tempocalendar",[function(){return{link:function(a){function b(b){for(var c=moment(b).startOf("month"),d=c.clone(),e=[],f=0;12>f;f++){e[f]={format:d.format("MMM<br/>YY"),days:[]};for(var g=d.clone(),h=d.clone().endOf("month"),i=h.diff(g,"days")+1,j=0;i>j;j++){var k={raw:"undefined",formated:"-"};a.events[d.format("YYYY-MM-DD")]&&(k=a.events[d.format("YYYY-MM-DD")]),e[f].days.push({date:d.clone(),data:k}),d=d.add(1,"days")}}return e}a.days=[];for(var c=0;31>c;c++)a.days.push(c+1);a.$watch("date",function(){a.calendar=b(a.date)}),a.$watch("events",function(){a.calendar=b(a.date)})},restrict:"E",scope:{date:"=divonaDate",events:"=ngModel",onDayClick:"=ngClick"},templateUrl:"/js/directives/tempocalendar.html",transclude:!0}}]),angular.module("tempoAdminApp").directive("ejpcalendar",[function(){return{link:function(a){function b(b){for(var c=moment(b).startOf("month"),d=c.clone(),e=[],f=0;12>f;f++){e[f]={format:d.format("MMM<br/>YY"),days:[]};for(var g=d.clone(),h=d.clone().endOf("month"),i=h.diff(g,"days")+1,j=0;i>j;j++){var k={north:void 0,paca:void 0,west:void 0,south:void 0};a.events&&a.events[d.format("YYYY-MM-DD")]&&(k.north=a.events[d.format("YYYY-MM-DD")].north.raw,k.paca=a.events[d.format("YYYY-MM-DD")].paca.raw,k.west=a.events[d.format("YYYY-MM-DD")].west.raw,k.south=a.events[d.format("YYYY-MM-DD")].south.raw),e[f].days.push({date:d.clone(),data:k}),d=d.add(1,"days")}}return e}a.days=[];for(var c=0;31>c;c++)a.days.push(c+1);a.$watch("date",function(){a.calendar=b(a.date)}),a.$watch("events",function(){a.calendar=b(a.date)})},restrict:"E",scope:{date:"=divonaDate",events:"=ngModel",onDayDblClick:"=ngDblclick",onDayZoneClick:"=ngClick"},templateUrl:"/js/directives/ejpcalendar.html",transclude:!0}}]),angular.module("tempoAdminApp").factory("Utils",[function(){return{apikey:""}}]),angular.module("divonaEjp",[]).constant("EJP_API_URL","http://api.tempo.18ruedivona.eu/ejp/").constant("EJP_API_FROM_MONTH",10).constant("EJP_API_FROM_DAY",1).constant("EJP_API_COUNT",22).factory("EJP",["$http","$q","EJP_API_URL","EJP_API_FROM_MONTH","EJP_API_FROM_DAY","EJP_API_COUNT",function(a,b,c,d,e,f){var g={},h={},i=function(){var a=moment();return a.month(d-1),a.date(e),a.subtract(1,"year"),moment().month()+1>=d&&a.add(1,"year"),a},j=function(){var b=i();return a.get(c+"count/"+b.format("YYYY-MM-DD")).then(function(a){return{north:f-a.data.north,paca:f-a.data.paca,west:f-a.data.west,south:f-a.data.south}})},k=function(a){return a?"EJP":"Non EJP"},l=function(a){for(var b=a.data,c={},d=0;d<b.length;d++){var e=b[d],f=moment(e.date.year+"-"+e.date.month+"-"+e.date.day,"YYYY-M-D");for(var g in e.zones)c[g]||(c[g]={}),c[g][f.format("YYYY-MM-DD")]={raw:e.zones[g],formated:k(e.zones[g])}}return c},m=function(a){for(var b=a.data,c={},d=0;d<b.length;d++){var e=b[d],f=moment(e.date.year+"-"+e.date.month+"-"+e.date.day,"YYYY-M-D"),g=f.format("YYYY-MM-DD");c[g]||(c[g]={});for(var h in e.zones)c[g][h]||(c[g][h]={}),c[g][h]={raw:e.zones[h],formated:k(e.zones[h])}}return c},n=function(d,e,f){if(angular.isUndefined(f)&&(f=!1),g[e]&&g[e][d]&&!f){var h=b.defer();return h.resolve(g[e][d]),h.promise}return a.get(c+e).then(function(a){return g[e]=l(a),g[e]})},o=function(d,e){if(angular.isUndefined(e)&&(e=!1),h[d]&&!e){var f=b.defer();return f.resolve(h[d]),f.promise}return a.get(c+d).then(function(a){return h[d]=m(a),h[d]})},p=function(d,e,f){if(!e.isValid())return b.reject("Invalid date");var g="object"==typeof f&&"boolean"==typeof f.north&&"boolean"==typeof f.paca&&"boolean"==typeof f.west&&"boolean"==typeof f.south;if(!g)return b.reject("Invalid zones");var h={year:e.format("YYYY"),month:e.format("M"),day:e.format("D"),zones:f};return a.post(c+"?apikey="+d,h)},q=function(d,e){return moment.isMoment(e)||(e=moment(e)),e.isValid()?a.delete(c+e.format("YYYY-MM-DD")+"?apikey="+d):b.reject("Invalid date")};return{getStartDate:i,getCounter:j,getMonthByZone:function(a,b,c){return n(a,b.format("YYYY-MM"),c)},getYearByZone:function(a,b,c){return n(a,b.format("YYYY"),c)},getMonthByDate:function(a,b){return o(a.format("YYYY-MM"),b)},getYearByDate:function(a,b){return o(a.format("YYYY"),b)},save:p,"delete":q}}]),angular.module("divonaForecast",[]).constant("FORECAST_API_URL","http://411279a3a8.url-de-test.ws").factory("Forecast",["$http","$q","FORECAST_API_URL",function(a,b,c){var d=function(a){switch(a){case"blue":return"Bleu";case"white":return"Blanc";case"red":return"Rouge"}},e=function(){return a.get(c+"/forecast").then(function(a){var b=a.data,c={today:{tempo:null,ejp:{north:null,paca:null,west:null,south:null}},tomorrow:{tempo:null,ejp:{north:null,paca:null,west:null,south:null}}};return b.today&&b.today.tempo&&(c.today.tempo={raw:b.today.tempo.color,format:d(b.today.tempo.color)}),b.tomorrow&&b.tomorrow.tempo&&(c.tomorrow.tempo={raw:b.tomorrow.tempo.color,format:d(b.tomorrow.tempo.color)}),c})};return{fetch:e}}]),angular.module("divonaTempo",[]).constant("TEMPO_API_URL","http://api.tempo.18ruedivona.eu").constant("TEMPO_API_FROM_MONTH",9).constant("TEMPO_API_FROM_DAY",1).constant("TEMPO_API_COUNT_BLUE",300).constant("TEMPO_API_COUNT_WHITE",43).constant("TEMPO_API_COUNT_RED",22).factory("Tempo",["$http","$q","TEMPO_API_URL","TEMPO_API_FROM_MONTH","TEMPO_API_FROM_DAY","TEMPO_API_COUNT_BLUE","TEMPO_API_COUNT_WHITE","TEMPO_API_COUNT_RED",function(a,b,c,d,e,f,g,h){var i={},j=function(a){switch(a){case"blue":return"Bleu";case"white":return"Blanc";case"red":return"Rouge"}},k=function(){var a=moment();return a.month(d-1),a.date(e),a.subtract(1,"year"),moment().month()+1>=d&&a.add(1,"year"),a},l=function(){var b=k();return moment().isLeapYear()&&(f+=1),a.get(c+"/tempo/count/"+b.format("YYYY-MM-DD")+"?"+moment().unix()).then(function(a){return{blue:f-a.data.blue,white:g-a.data.white,red:h-a.data.red}})},m=function(a){var b={};return angular.forEach(a,function(a){var c=moment(a.date.year+"-"+a.date.month+"-"+a.date.day,"YYYY-M-D");b[c.format("YYYY-MM-DD")]={raw:a.color,formated:j(a.color)}}),b},n=function(d,e){if(angular.isUndefined(e)&&(e=!1),i[d]&&!e){var f=b.defer();return f.resolve(i[d]),f.promise}return a.get(c+"/tempo/"+d+"?"+moment().unix()).then(function(a){return i[d]=m(a.data),i[d]})},o=function(d,e,f){if(moment.isMoment(e)||(e=moment(e)),!e.isValid())return b.reject("Invalid date");if("blue"!==f&&"white"!==f&&"red"!==f)return b.reject("Invalid color");var g={year:e.format("YYYY"),month:e.format("M"),day:e.format("D"),color:f};return a.post(c+"/tempo?apikey="+d,g)},p=function(d,e){return moment.isMoment(e)||(e=moment(e)),e.isValid()?a.delete(c+"/tempo/"+e.format("YYYY-MM-DD")+"?apikey="+d):b.reject("Invalid date")};return{formatColor:j,getStartDate:k,getCounter:l,getMonth:function(a,b){return n(a.format("YYYY-MM"),b)},getYear:function(a,b){return n(a.format("YYYY"),b)},save:o,"delete":p}}]);